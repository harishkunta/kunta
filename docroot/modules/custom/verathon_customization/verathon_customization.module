<?php

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Render\Markup;
use Drupal\node\Entity\Node;
use Drupal\media\Entity\Media;
use Drupal\file\Entity\File;
use Drupal\Component\Utility\Html;
use Drupal\views\ViewExecutable;

/**
 * Implements hook_css_alter().
 */
function verathon_customization_h5p_styles_alter(&$styles, $libraries, $mode) {
  $styles[] = (object) array(
    // Path relative to drupal root
    'path' => drupal_get_path('module', 'verathon_customization') . '/css/custom-h5p-overrides.css',
    // Cache buster
    'version' => '?ver=1',
  );
}

/**
 * Implements hook_js_alter().
 */
function verathon_customization_h5p_scripts_alter(&$scripts, $libraries, $mode) {
  $scripts[] = (object) array(
    // Path relative to drupal root
    'path' => drupal_get_path('module', 'verathon_customization') . '/js/custom-h5p-overrides.js',
    // Cache buster
    'version' => '?ver=1',
  );
}

/**
 * Implements hook_form_alter().
 */
function verathon_customization_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  if ($form_id === 'views_exposed_form' && isset($form['field_product_line'])) {
    if ('views-exposed-form-et-search-block-search' === $form['#id']) {
      // Rename the All option label.
      $form['field_product_line']['#options']['All'] = t('All Products');
    }
    if ('views-exposed-form-acquia-search-search' === $form['#id']) {
      // Rename the All option label.
      $form['field_product_line']['#options']['All'] = t('All');
      $form['#attached']['library'][] = 'verathon_customization/verathon_search';
    }
  }

}

/**
 * Implements hook_preprocess_html().
 */
function verathon_customization_preprocess_html(array &$variables) {
  $current_theme = \Drupal::service('theme.manager')->getActiveTheme()->getName();

  if ($current_theme !== 'cohesion_theme') {
    return;
  }

  $variables['#attached']['library'][] =  'verathon_customization/global-styling';

  $pageCategory = $siteSection = NULL;
  $path = \Drupal::service('path.current')->getPath();
  $path_args = explode('/', $path);
  $path_args = array_filter($path_args);
  $alias = \Drupal::service('path_alias.manager')->getAliasByPath($path);
  $alias_args = explode('/', $alias);
  $alias_args = array_filter($alias_args);
  $siteSection = $alias_args[1] ?? '';

  if ($path_args[1] == 'node' && is_numeric($path_args[2])) {
    $node = Node::load($path_args[2]);
    $pageCategory = ucwords($node->bundle());
    if ($node->bundle() == 'page') {
      $is_product = $node->get('field_is_product')->value;
      if (!empty($is_product) && $is_product == 1) {
        $pageCategory = 'Product';
      }
    }
  }
  else {
    $pageCategory = 'sitepage';
  }

  $datalayer = [
    '#tag' => 'script',
    '#value' => Markup::create("dataLayer = [{
      'pageCategory': '$pageCategory',
      'siteSection' : '$siteSection',
    }];"),
  ];

  $telephone = [
    '#tag' => 'meta',
    '#attributes' => [
      'name' => 'format-detection',
      'content' => 'telephone=no'
    ],
  ];

  $xuacompatible = [
    '#tag' => 'meta',
    '#attributes' => [
      'http-equiv' => 'x-ua-compatible',
      'content' => 'ie=edge',
    ],
  ];

  $variables['page']['#attached']['html_head'][] = [$datalayer, 'dataLayer'];
  $variables['page']['#attached']['html_head'][] = [$telephone, 'telephone'];
  $variables['page']['#attached']['html_head'][] = [$xuacompatible, 'x-ua-compatible'];
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function verathon_customization_form_views_exposed_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  if ( !empty($form) &&  $form['#id'] === 'views-exposed-form-product-support-cards-eol-prod-doc-list' ) {
    $form['#attributes']['class'][] = Html::cleanCssIdentifier('coh-style-eol-product-documentation-list');
    $form['#attributes']['class'][] = Html::cleanCssIdentifier('coh-container-boxed');
    $form = change_labels($form);
  }
  if ( !empty($form) &&  $form['#id'] === 'views-exposed-form-product-support-cards-prod-support-doc-list' ) {
    $form['#attributes']['class'][] = Html::cleanCssIdentifier('coh-style-product-documentation-form-and-list');
    $form = change_labels($form);
    //Adding a new field in the exposed form for Product Support page
    $form['contact_rep_text'] = [
      '#type' => 'markup',
      '#markup' => Markup::create('<div class="contact-rep"><span class="contact-local-rep">' .t("To obtain a previous version of a manual, please contact your local representative or Customer Care") . '</span></div>'),
    ];
  }
  // List the countries which is created under the Countries and Regions vocabulary.
  if ( !empty($form) &&  $form['#id'] === 'views-exposed-form-global-technical-support-gts-block' ) {
    // Fetching the country code from the Address table.
    $query = \Drupal::database()->select('taxonomy_term__field_address', 'fa');
    $query->addField('fa', 'field_address_country_code');
    $query->condition('fa.bundle', 'countries_and_regions');
    $country_codes = $query->orderBy('field_address_country_code', 'ASC')->execute()->fetchCol();
    $countries['All'] = $form['field_address_country_code']['#options']['All'];
    foreach ($country_codes as $country_code) {
      $countries[$country_code] = $form['field_address_country_code']['#options'][$country_code];
    }
    $form['field_address_country_code']['#options'] = $countries;
  }
}

/**
 * Change Labels for the default value in the exposed form select list
 */
function change_labels($form) {
  if (isset($form['lang'])) {
    $form['lang']['#options']['All'] = t('All Languages');
  }
  if (isset($form['doc_type'])) {
    $form['doc_type']['#options']['All'] = t('All Documents');
  }
  return $form;
}
